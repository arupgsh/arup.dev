---
import { SITE } from "@/config";

const { enabled, repo, repoId, category, categoryId, mapping, reactionsEnabled, emitMetadata, inputPosition, theme, lang } = SITE.giscus;

// Only render if giscus is enabled
if (!enabled) {
  return null;
}
---

{enabled && (
  <div class="giscus-wrapper mt-8">
    <script
      is:inline
      src="https://giscus.app/client.js"
      data-repo={repo}
      data-repo-id={repoId}
      data-category={category}
      data-category-id={categoryId}
      data-mapping={mapping}
      data-strict="0"
      data-reactions-enabled={reactionsEnabled}
      data-emit-metadata={emitMetadata}
      data-input-position={inputPosition}
      data-theme={theme}
      data-lang={lang}
      data-loading="lazy"
      crossorigin="anonymous"
      async
    ></script>
  </div>
)}

<script is:inline>
  // Sync giscus theme with site theme
  function setGiscusTheme() {
    const theme = localStorage.getItem("theme") || "light";
    const giscusTheme = theme === "dark" ? "dark" : "light";
    
    function sendMessage(message) {
      const iframe = document.querySelector('iframe.giscus-frame');
      if (iframe) {
        iframe.contentWindow?.postMessage({ giscus: message }, 'https://giscus.app');
      }
    }
    
    sendMessage({
      setConfig: {
        theme: giscusTheme,
      },
    });
  }

  // Set theme on page load
  document.addEventListener('DOMContentLoaded', setGiscusTheme);
  
  // Listen for theme changes
  const observer = new MutationObserver(() => setGiscusTheme());
  observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme', 'class'] });
  
  // Update theme after page swap (Astro view transitions)
  document.addEventListener('astro:after-swap', setGiscusTheme);
</script>
